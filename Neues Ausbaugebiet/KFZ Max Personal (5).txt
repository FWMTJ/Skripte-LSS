// ==UserScript==
// @name         Change Vehicle max personel - Enhanced UI
// @namespace    http://tampermonkey.net/
// @version      2.0
// @description  Change the vehicle max allowed personal across multiple buildings with enhanced UI
// @author       Silberfighter
// @include      https://www.leitstellenspiel.de/
// @include      https://www.leitstellenspiel.de/buildings/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=leitstellenspiel.de
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_notification
// @grant        GM_xmlhttpRequest
// @grant        GM_addStyle
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// ==/UserScript==

(function() {
    'use strict';

    // Konfiguration: [VehicleTypeID, MaxPersonen]
    const VEHICLE_CONFIG = [
        [35, 1],  // VehicleType 35 auf 1 Person
        [50, 1],  // VehicleType 50 auf 1 Person
        // Weitere Eintr√§ge hier hinzuf√ºgen...
    ];

    const SETTINGS = {
        delayBetweenRequests: 500,
        batchDelay: 1000,
        maxConcurrentRequests: 3
    };

    class VehiclePersonalManager {
        constructor() {
            this.isRunning = false;
            this.currentProcess = null;
            this.activeRequests = 0;
            this.init();
        }

        init() {
            if (this.isStartPage()) {
                console.log('Vehicle Personal Manager: Startseite erkannt');
                this.createUI();
                this.loadLeitstellen();
            }
        }

        isStartPage() {
            return window.location.href === 'https://www.leitstellenspiel.de/' ||
                   window.location.href.includes('/buildings/');
        }

        createUI() {
            if (document.getElementById('lss-vehicle-personal-manager')) return;

            this.addStyles();

            const container = document.createElement('div');
            container.id = 'lss-vehicle-personal-manager';

            const header = document.createElement('div');
            header.id = 'lss-vehicle-personal-header';

            const title = document.createElement('div');
            title.id = 'lss-vehicle-personal-title';
            title.textContent = 'üöö Fahrzeug Personal Manager';

            const close = document.createElement('button');
            close.id = 'lss-vehicle-personal-close';
            close.textContent = '√ó';
            close.addEventListener('click', () => container.style.display = 'none');

            header.appendChild(title);
            header.appendChild(close);

            const content = document.createElement('div');
            content.id = 'lss-vehicle-personal-content';

            content.appendChild(this.createStationSection());
            content.appendChild(this.createBuildingSection());
            content.appendChild(this.createConfigSection());
            content.appendChild(this.createActionSection());
            content.appendChild(this.createStatusSection());
            content.appendChild(this.createProgressSection());

            container.appendChild(header);
            container.appendChild(content);
            document.body.appendChild(container);

            this.makeDraggable(container, header);
        }

        addStyles() {
            const css = `
                #lss-vehicle-personal-manager {
                    position: fixed;
                    top: 120px;
                    left: 20px;
                    width: 600px;
                    background: #2d3748;
                    color: #e2e8f0;
                    border: 1px solid #4a5568;
                    border-radius: 8px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    z-index: 9999;
                    font-family: Arial, sans-serif;
                    max-height: 85vh;
                    display: flex;
                    flex-direction: column;
                }

                #lss-vehicle-personal-header {
                    background: #1a202c;
                    padding: 12px;
                    border-radius: 8px 8px 0 0;
                    cursor: move;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-bottom: 1px solid #4a5568;
                }

                #lss-vehicle-personal-title {
                    font-weight: bold;
                    font-size: 16px;
                    color: #f7fafc;
                }

                #lss-vehicle-personal-close {
                    background: none;
                    border: none;
                    color: #e2e8f0;
                    font-size: 18px;
                    cursor: pointer;
                    width: 24px;
                    height: 24px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                #lss-vehicle-personal-content {
                    padding: 15px;
                    overflow-y: auto;
                    flex-grow: 1;
                }

                .lss-section {
                    margin-bottom: 15px;
                    padding-bottom: 15px;
                    border-bottom: 1px solid #4a5568;
                }

                .lss-section:last-child {
                    border-bottom: none;
                    margin-bottom: 0;
                }

                .lss-section-title {
                    font-weight: bold;
                    margin-bottom: 8px;
                    color: #63b3ed;
                    font-size: 14px;
                }

                .lss-btn {
                    display: block;
                    width: 100%;
                    padding: 10px;
                    margin: 8px 0;
                    background: #3182ce;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    text-align: center;
                    transition: background 0.2s;
                    font-size: 13px;
                }

                .lss-btn:hover { background: #2b6cb0; }
                .lss-btn:disabled { background: #4a5568; color: #a0aec0; cursor: not-allowed; }
                .lss-btn-success { background: #38a169; }
                .lss-btn-success:hover { background: #2f855a; }
                .lss-btn-danger { background: #e53e3e; }
                .lss-btn-danger:hover { background: #c53030; }
                .lss-btn-warning { background: #ed8936; }
                .lss-btn-warning:hover { background: #dd771b; }

                .lss-select {
                    width: 100%;
                    padding: 8px;
                    margin: 8px 0;
                    background: #4a5568;
                    color: #e2e8f0;
                    border: 1px solid #718096;
                    border-radius: 6px;
                    font-size: 13px;
                }

                .lss-building-list {
                    max-height: 200px;
                    overflow-y: auto;
                    border: 1px solid #4a5568;
                    border-radius: 6px;
                    padding: 10px;
                    background: #1a202c;
                }

                .lss-building-item {
                    margin: 6px 0;
                    padding: 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: background 0.2s;
                    border: 1px solid transparent;
                    display: flex;
                    align-items: center;
                }

                .lss-building-item:hover {
                    background: #2d3748;
                    border-color: #4a5568;
                }

                .lss-building-item input {
                    margin-right: 8px;
                }

                .lss-building-item label {
                    cursor: pointer;
                    flex: 1;
                }

                .lss-message {
                    padding: 10px;
                    margin: 8px 0;
                    border-radius: 6px;
                    font-size: 12px;
                    line-height: 1.4;
                }

                .lss-success { background: #22543d; color: #9ae6b4; border-left: 4px solid #38a169; }
                .lss-error { background: #742a2a; color: #feb2b2; border-left: 4px solid #e53e3e; }
                .lss-info { background: #2c5282; color: #90cdf4; border-left: 4px solid #3182ce; }
                .lss-warning { background: #744210; color: #faf089; border-left: 4px solid #ed8936; }

                .lss-progress-container {
                    margin: 10px 0;
                }

                .lss-progress-label {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 5px;
                    font-size: 12px;
                    color: #a0aec0;
                }

                .lss-progress {
                    width: 100%;
                    height: 20px;
                    background: #4a5568;
                    border-radius: 10px;
                    overflow: hidden;
                }

                .lss-progress-bar {
                    height: 100%;
                    background: linear-gradient(45deg, #48bb78, #38a169);
                    transition: width 0.3s;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 11px;
                    font-weight: bold;
                }

                .lss-stats {
                    display: grid;
                    grid-template-columns: 1fr 1fr 1fr;
                    gap: 10px;
                    margin: 10px 0;
                }

                .lss-stat-item {
                    background: #4a5568;
                    padding: 8px;
                    border-radius: 6px;
                    text-align: center;
                }

                .lss-stat-value {
                    font-size: 18px;
                    font-weight: bold;
                    color: #63b3ed;
                }

                .lss-stat-label {
                    font-size: 11px;
                    color: #a0aec0;
                }

                .lss-config-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 10px 0;
                    font-size: 12px;
                }

                .lss-config-table th,
                .lss-config-table td {
                    border: 1px solid #4a5568;
                    padding: 8px;
                    text-align: left;
                }

                .lss-config-table th {
                    background: #1a202c;
                    color: #63b3ed;
                }

                .lss-config-table td {
                    background: #4a5568;
                }

                .lss-log {
                    max-height: 150px;
                    overflow-y: auto;
                    background: #1a202c;
                    border: 1px solid #4a5568;
                    border-radius: 6px;
                    padding: 8px;
                    font-size: 11px;
                    font-family: monospace;
                }

                .lss-log-entry {
                    margin: 2px 0;
                    padding: 2px 4px;
                    border-radius: 3px;
                }

                .lss-log-success { background: #22543d; color: #9ae6b4; }
                .lss-log-error { background: #742a2a; color: #feb2b2; }
                .lss-log-info { background: #2c5282; color: #90cdf4; }
                .lss-log-warning { background: #744210; color: #faf089; }
            `;

            const style = document.createElement('style');
            style.textContent = css;
            document.head.appendChild(style);
        }

        createStationSection() {
            const section = document.createElement('div');
            section.className = 'lss-section';

            const title = document.createElement('div');
            title.className = 'lss-section-title';
            title.textContent = 'üìç Leitstelle ausw√§hlen';

            const select = document.createElement('select');
            select.className = 'lss-select';
            select.id = 'lss-leitstellen-select';
            select.innerHTML = '<option value="">Leitstellen werden geladen...</option>';

            section.appendChild(title);
            section.appendChild(select);
            return section;
        }

        createBuildingSection() {
            const section = document.createElement('div');
            section.className = 'lss-section';

            const title = document.createElement('div');
            title.className = 'lss-section-title';
            title.textContent = 'üè¢ Geb√§ude ausw√§hlen';

            const selectAll = document.createElement('div');
            selectAll.style.cssText = 'margin-bottom: 10px; font-size: 12px; display: flex; align-items: center;';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = 'lss-select-all';

            const label = document.createElement('label');
            label.htmlFor = 'lss-select-all';
            label.textContent = 'Alle Geb√§ude ausw√§hlen';
            label.style.marginLeft = '8px';

            selectAll.appendChild(checkbox);
            selectAll.appendChild(label);

            const buildingList = document.createElement('div');
            buildingList.id = 'lss-building-list';
            buildingList.className = 'lss-building-list';
            buildingList.innerHTML = '<div class="lss-message lss-info">Bitte zuerst eine Leitstelle ausw√§hlen</div>';

            section.appendChild(title);
            section.appendChild(selectAll);
            section.appendChild(buildingList);

            checkbox.addEventListener('change', (e) => this.handleSelectAll(e.target.checked));
            return section;
        }

        createConfigSection() {
            const section = document.createElement('div');
            section.className = 'lss-section';

            const title = document.createElement('div');
            title.className = 'lss-section-title';
            title.textContent = '‚öôÔ∏è Konfiguration';

            const table = document.createElement('table');
            table.className = 'lss-config-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Fahrzeugtyp ID</th>
                        <th>Max. Personen</th>
                    </tr>
                </thead>
                <tbody>
                    ${VEHICLE_CONFIG.map(config => `
                        <tr>
                            <td>${config[0]}</td>
                            <td>${config[1]}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            const info = document.createElement('div');
            info.className = 'lss-message lss-info';
            info.innerHTML = `
                <strong>Aktuelle Konfiguration:</strong><br>
                ${VEHICLE_CONFIG.map(config => `‚Ä¢ Typ ${config[0]} ‚Üí ${config[1]} Person(en)`).join('<br>')}
            `;

            section.appendChild(title);
            section.appendChild(table);
            section.appendChild(info);
            return section;
        }

        createActionSection() {
            const section = document.createElement('div');
            section.className = 'lss-section';

            const title = document.createElement('div');
            title.className = 'lss-section-title';
            title.textContent = '‚ö° Aktionen';

            const startBtn = document.createElement('button');
            startBtn.className = 'lss-btn lss-btn-success';
            startBtn.id = 'lss-start-process';
            startBtn.textContent = 'üöÄ Personal-Limits anwenden';
            startBtn.disabled = true;

            const stopBtn = document.createElement('button');
            stopBtn.className = 'lss-btn lss-btn-danger';
            stopBtn.id = 'lss-stop-process';
            stopBtn.textContent = '‚èπÔ∏è Prozess stoppen';
            stopBtn.style.display = 'none';

            section.appendChild(title);
            section.appendChild(startBtn);
            section.appendChild(stopBtn);
            return section;
        }

        createStatusSection() {
            const section = document.createElement('div');
            section.className = 'lss-section';

            const title = document.createElement('div');
            title.className = 'lss-section-title';
            title.textContent = 'üìä Status';

            const message = document.createElement('div');
            message.id = 'lss-status-message';
            message.className = 'lss-message lss-info';
            message.textContent = 'Bereit - W√§hle eine Leitstelle und Geb√§ude aus';

            section.appendChild(title);
            section.appendChild(message);
            return section;
        }

        createProgressSection() {
            const section = document.createElement('div');
            section.className = 'lss-section';

            const title = document.createElement('div');
            title.className = 'lss-section-title';
            title.textContent = 'üìà Fortschritt';

            const stats = document.createElement('div');
            stats.className = 'lss-stats';

            stats.innerHTML = `
                <div class="lss-stat-item">
                    <div class="lss-stat-value" id="lss-stat-completed">0</div>
                    <div class="lss-stat-label">Bearbeitet</div>
                </div>
                <div class="lss-stat-item">
                    <div class="lss-stat-value" id="lss-stat-total">0</div>
                    <div class="lss-stat-label">Gesamt</div>
                </div>
                <div class="lss-stat-item">
                    <div class="lss-stat-value" id="lss-stat-success">0</div>
                    <div class="lss-stat-label">Erfolgreich</div>
                </div>
            `;

            const progressContainer = document.createElement('div');
            progressContainer.className = 'lss-progress-container';

            const progressLabel = document.createElement('div');
            progressLabel.className = 'lss-progress-label';
            progressLabel.innerHTML = '<span>Gesamtfortschritt</span><span id="lss-progress-percent">0%</span>';

            const progress = document.createElement('div');
            progress.className = 'lss-progress';
            progress.innerHTML = '<div class="lss-progress-bar" style="width: 0%"></div>';

            progressContainer.appendChild(progressLabel);
            progressContainer.appendChild(progress);

            const currentTask = document.createElement('div');
            currentTask.id = 'lss-current-task';
            currentTask.className = 'lss-message lss-info';
            currentTask.textContent = 'Keine aktive Aufgabe';

            const log = document.createElement('div');
            log.className = 'lss-log';
            log.id = 'lss-process-log';
            log.innerHTML = '<div class="lss-log-entry lss-log-info">Bereit f√ºr Personal-Limit-√Ñnderungen...</div>';

            section.appendChild(title);
            section.appendChild(stats);
            section.appendChild(progressContainer);
            section.appendChild(currentTask);
            section.appendChild(log);

            return section;
        }

        async loadLeitstellen() {
            try {
                this.showMessage('Lade Leitstellen...', 'info');
                const buildings = await this.apiCall('/api/buildings');
                const leitstellen = buildings.filter(b => b.building_type === 7);

                const select = document.getElementById('lss-leitstellen-select');
                select.innerHTML = '';

                if (leitstellen.length === 0) {
                    select.innerHTML = '<option value="">Keine Leitstellen gefunden</option>';
                    this.showMessage('Keine Leitstellen gefunden', 'warning');
                } else {
                    select.innerHTML = '<option value="">Leitstelle ausw√§hlen</option>';
                    leitstellen.forEach(ls => {
                        const option = document.createElement('option');
                        option.value = ls.id;
                        option.textContent = ls.caption;
                        select.appendChild(option);
                    });
                    this.showMessage(`${leitstellen.length} Leitstellen geladen`, 'success');
                }

                select.addEventListener('change', () => this.handleLeitstellenChange());
                document.getElementById('lss-start-process').addEventListener('click', () => this.startProcess());
                document.getElementById('lss-stop-process').addEventListener('click', () => this.stopProcess());

            } catch (error) {
                console.error('Fehler beim Laden der Leitstellen:', error);
                this.showMessage('Fehler beim Laden der Leitstellen', 'error');
            }
        }

        async handleLeitstellenChange() {
            const leitstellenId = document.getElementById('lss-leitstellen-select').value;
            if (!leitstellenId) return;

            try {
                this.showMessage('Lade Geb√§ude...', 'info');
                const buildings = await this.apiCall('/api/buildings');
                const gebaeude = buildings.filter(b =>
                    b.building_type !== 7 && b.leitstelle_building_id == leitstellenId
                );

                const buildingList = document.getElementById('lss-building-list');
                buildingList.innerHTML = '';

                if (gebaeude.length === 0) {
                    buildingList.innerHTML = '<div class="lss-message lss-warning">Keine Geb√§ude in dieser Leitstelle gefunden</div>';
                    this.showMessage('Keine Geb√§ude gefunden', 'warning');
                    return;
                }

                gebaeude.forEach(building => {
                    const item = document.createElement('div');
                    item.className = 'lss-building-item';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = building.id;

                    const label = document.createElement('label');
                    label.textContent = building.caption;

                    item.appendChild(checkbox);
                    item.appendChild(label);

                    item.addEventListener('click', (e) => {
                        if (e.target !== checkbox) {
                            checkbox.checked = !checkbox.checked;
                        }
                        this.updateStartButton();
                    });

                    buildingList.appendChild(item);
                });

                this.showMessage(`${gebaeude.length} Geb√§ude geladen`, 'success');
                this.updateStartButton();

            } catch (error) {
                console.error('Fehler beim Laden der Geb√§ude:', error);
                this.showMessage('Fehler beim Laden der Geb√§ude', 'error');
            }
        }

        handleSelectAll(checked) {
            const checkboxes = document.querySelectorAll('#lss-building-list input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checked);
            this.updateStartButton();
        }

        updateStartButton() {
            const selected = this.getSelectedBuildings();
            const btn = document.getElementById('lss-start-process');
            btn.disabled = selected.length === 0;

            if (selected.length > 0) {
                this.showMessage(`${selected.length} Geb√§ude ausgew√§hlt`, 'success');
            } else {
                this.showMessage('Keine Geb√§ude ausgew√§hlt', 'info');
            }
        }

        getSelectedBuildings() {
            const checkboxes = document.querySelectorAll('#lss-building-list input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => ({
                id: cb.value,
                name: cb.nextElementSibling.textContent
            }));
        }

        async startProcess() {
            if (this.isRunning) {
                this.showMessage('Prozess l√§uft bereits', 'warning');
                return;
            }

            const selectedBuildings = this.getSelectedBuildings();
            if (selectedBuildings.length === 0) {
                this.showMessage('Bitte Geb√§ude ausw√§hlen', 'error');
                return;
            }

            this.isRunning = true;
            this.currentProcess = {
                buildings: selectedBuildings,
                currentBuildingIndex: 0,
                processedVehicles: 0,
                totalVehicles: 0,
                successfulChanges: 0,
                failedChanges: 0,
                startTime: Date.now()
            };

            document.getElementById('lss-start-process').style.display = 'none';
            document.getElementById('lss-stop-process').style.display = 'block';
            document.getElementById('lss-leitstellen-select').disabled = true;
            document.querySelectorAll('#lss-building-list input').forEach(cb => cb.disabled = true);

            this.showMessage('Starte Personal-Limit-√Ñnderungen...', 'info');
            this.addLog('üöÄ Personal-Limit-Prozess gestartet', 'info');
            this.addLog(`üè¢ ${selectedBuildings.length} Geb√§ude ausgew√§hlt`, 'info');

            await this.calculateTotalVehicles();
            this.processNextBuilding();
        }

        async calculateTotalVehicles() {
            this.currentProcess.totalVehicles = 0;

            for (const building of this.currentProcess.buildings) {
                try {
                    const vehicles = await this.apiCall(`/api/buildings/${building.id}/vehicles`);
                    const relevantVehicles = vehicles.filter(v =>
                        VEHICLE_CONFIG.some(c => c[0] == v.vehicle_type)
                    );

                    this.currentProcess.totalVehicles += relevantVehicles.length;
                    this.addLog(`üìä ${building.name}: ${relevantVehicles.length} relevante Fahrzeuge`, 'info');
                } catch (error) {
                    console.error(`Fehler beim Laden der Fahrzeuge f√ºr ${building.name}:`, error);
                    this.addLog(`‚ùå Fehler beim Laden von ${building.name}`, 'error');
                }
            }

            this.updateStats();
            this.addLog(`üìà Gesamt: ${this.currentProcess.totalVehicles} relevante Fahrzeuge`, 'info');
        }

        async processNextBuilding() {
            if (!this.isRunning) return;

            if (this.currentProcess.currentBuildingIndex >= this.currentProcess.buildings.length) {
                this.addLog('‚úÖ Alle Geb√§ude abgeschlossen!', 'success');
                this.showMessage('Personal-Limit-Prozess abgeschlossen!', 'success');
                this.stopProcess();
                return;
            }

            const building = this.currentProcess.buildings[this.currentProcess.currentBuildingIndex];

            try {
                this.addLog(`üè¢ Starte Geb√§ude: ${building.name}`, 'info');
                this.updateCurrentTask(`Bearbeite Geb√§ude: ${building.name}`);

                const vehicles = await this.apiCall(`/api/buildings/${building.id}/vehicles`);
                const relevantVehicles = vehicles.filter(v =>
                    VEHICLE_CONFIG.some(c => c[0] == v.vehicle_type)
                );

                if (relevantVehicles.length === 0) {
                    this.addLog(`‚ÑπÔ∏è Keine relevanten Fahrzeuge in ${building.name}`, 'info');
                    this.currentProcess.currentBuildingIndex++;
                    await this.delay(SETTINGS.batchDelay);
                    this.processNextBuilding();
                    return;
                }

                await this.processBuildingVehicles(building, relevantVehicles);

                this.currentProcess.currentBuildingIndex++;
                await this.delay(SETTINGS.batchDelay);
                this.processNextBuilding();

            } catch (error) {
                console.error(`Fehler beim Verarbeiten von Geb√§ude ${building.name}:`, error);
                this.addLog(`‚ùå Fehler bei ${building.name}, √ºberspringe...`, 'error');

                this.currentProcess.currentBuildingIndex++;
                await this.delay(SETTINGS.batchDelay);
                this.processNextBuilding();
            }
        }

        async processBuildingVehicles(building, vehicles) {
            for (const vehicle of vehicles) {
                if (!this.isRunning) break;

                while (this.activeRequests >= SETTINGS.maxConcurrentRequests) {
                    await this.delay(100);
                    if (!this.isRunning) break;
                }

                await this.processSingleVehicle(building, vehicle);
                await this.delay(SETTINGS.delayBetweenRequests);
            }
        }

        async processSingleVehicle(building, vehicle) {
            this.activeRequests++;

            try {
                const config = VEHICLE_CONFIG.find(c => c[0] == vehicle.vehicle_type);
                if (!config) {
                    this.addLog(`‚ùå Keine Konfiguration f√ºr Fahrzeug ${vehicle.caption} (Typ ${vehicle.vehicle_type})`, 'error');
                    this.currentProcess.failedChanges++;
                    return;
                }

                const newMaxPersonnel = config[1];

                if (vehicle.personal_max === newMaxPersonnel) {
                    this.addLog(`‚ÑπÔ∏è ${vehicle.caption} hat bereits ${newMaxPersonnel} Personen`, 'info');
                    this.currentProcess.successfulChanges++;
                } else {
                    const success = await this.updateVehicleMaxPersonnel(vehicle.id, newMaxPersonnel);

                    if (success) {
                        this.addLog(`‚úÖ ${vehicle.caption}: ${vehicle.personal_max} ‚Üí ${newMaxPersonnel} Personen`, 'success');
                        this.currentProcess.successfulChanges++;
                    } else {
                        this.addLog(`‚ùå ${vehicle.caption}: Fehler beim Update`, 'error');
                        this.currentProcess.failedChanges++;
                    }
                }

                this.currentProcess.processedVehicles++;
                this.updateProgress();

            } catch (error) {
                console.error(`Fehler bei Fahrzeug ${vehicle.id}:`, error);
                this.addLog(`‚ùå ${vehicle.caption}: ${error.message}`, 'error');
                this.currentProcess.failedChanges++;
                this.currentProcess.processedVehicles++;
            } finally {
                this.activeRequests--;
                this.updateProgress();
            }
        }

        async updateVehicleMaxPersonnel(vehicleId, maxPersonnel) {
            return new Promise((resolve, reject) => {
                const authenticityToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

                if (!authenticityToken) {
                    reject(new Error('CSRF Token nicht gefunden'));
                    return;
                }

                GM_xmlhttpRequest({
                    method: 'POST',
                    url: `https://www.leitstellenspiel.de/vehicles/${vehicleId}`,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    data: `vehicle%5Bpersonal_max%5D=${maxPersonnel}&_method=put&authenticity_token=${encodeURIComponent(authenticityToken)}`,
                    onload: function(response) {
                        if (response.status === 200) {
                            resolve(true);
                        } else {
                            reject(new Error(`HTTP ${response.status}`));
                        }
                    },
                    onerror: function(error) {
                        reject(error);
                    }
                });
            });
        }

        stopProcess() {
            this.isRunning = false;

            document.getElementById('lss-start-process').style.display = 'block';
            document.getElementById('lss-stop-process').style.display = 'none';
            document.getElementById('lss-leitstellen-select').disabled = false;
            document.querySelectorAll('#lss-building-list input').forEach(cb => cb.disabled = false);

            document.getElementById('lss-current-task').textContent = 'Keine aktive Aufgabe';
            document.getElementById('lss-current-task').className = 'lss-message lss-info';

            if (this.currentProcess && this.currentProcess.startTime) {
                const runtime = Math.round((Date.now() - this.currentProcess.startTime) / 1000);
                this.addLog(`‚è±Ô∏è Laufzeit: ${runtime} Sekunden`, 'info');
            }

            this.showMessage('Prozess gestoppt', 'info');
            this.addLog('‚èπÔ∏è Prozess gestoppt', 'info');
        }

        updateCurrentTask(message) {
            const currentTask = document.getElementById('lss-current-task');
            currentTask.textContent = message;
            currentTask.className = 'lss-message lss-info';
        }

        updateProgress() {
            const total = this.currentProcess.totalVehicles;
            const processed = this.currentProcess.processedVehicles;
            const percent = total > 0 ? (processed / total) * 100 : 0;

            const progressBar = document.querySelector('.lss-progress-bar');
            const progressPercent = document.getElementById('lss-progress-percent');

            if (progressBar) {
                progressBar.style.width = `${percent}%`;
                progressBar.textContent = `${Math.round(percent)}%`;
            }
            if (progressPercent) progressPercent.textContent = `${Math.round(percent)}%`;

            this.updateStats();
        }

        updateStats() {
            if (!this.currentProcess) return;

            document.getElementById('lss-stat-completed').textContent = this.currentProcess.processedVehicles;
            document.getElementById('lss-stat-total').textContent = this.currentProcess.totalVehicles;
            document.getElementById('lss-stat-success').textContent = this.currentProcess.successfulChanges;
        }

        addLog(message, type = 'info') {
            const log = document.getElementById('lss-process-log');
            const entry = document.createElement('div');
            entry.className = `lss-log-entry lss-log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);

            const entries = log.querySelectorAll('.lss-log-entry');
            if (entries.length > 100) {
                entries[0].remove();
            }

            log.scrollTop = log.scrollHeight;
        }

        async apiCall(url) {
            return new Promise((resolve, reject) => {
                GM_xmlhttpRequest({
                    method: 'GET',
                    url: `https://www.leitstellenspiel.de${url}`,
                    credentials: 'include',
                    onload: (response) => {
                        if (response.status === 200) {
                            try {
                                const data = JSON.parse(response.responseText);
                                resolve(data.result || data);
                            } catch (e) {
                                reject(e);
                            }
                        } else {
                            reject(new Error(`API Error: ${response.status}`));
                        }
                    },
                    onerror: reject
                });
            });
        }

        showMessage(message, type = 'info') {
            const element = document.getElementById('lss-status-message');
            if (element) {
                element.textContent = message;
                element.className = `lss-message lss-${type}`;
            }
        }

        makeDraggable(element, handle) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            handle.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    }

    // Initialisiere den Manager
    new VehiclePersonalManager();

})();