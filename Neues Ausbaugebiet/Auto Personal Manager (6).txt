// ==UserScript==
// @name         LSS Auto Personal Manager - Sequentiell mit Batch (Optimized)
// @namespace    http://tampermonkey.net/
// @version      4.0
// @description  Automatische Personalzuweisung sequentiell mit Batch-Verarbeitung
// @author       You
// @match        https://www.leitstellenspiel.de/
// @match        https://www.leitstellenspiel.de/buildings/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=leitstellenspiel.de
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_notification
// @grant        GM_xmlhttpRequest
// @grant        GM_addStyle
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// ==/UserScript==

(function() {
    'use strict';

    const VEHICLE_CONFIG = [
        ["35", "Zugf√ºhrer (leBefKw)", 1],
        ["50", "", 1],
        ["29", "", 1],
        ["29", "Notarzt", 1],
        ["74", "", 2],
        ["74", "Notarzt", 1],
    ];

    const SETTINGS = {
        pressDelay: 300,
        pageLoadDelay: 2000,
        apiDelay: 200,
        betweenVehicles: 700,
        betweenBatches: 1000,
        betweenBuildings: 2000,
        retryDelay: 100,
        batchSize: 3,
        maxConcurrentFrames: 5,
        batchDelay: 800
    };

    class BatchManager {
        constructor(mainManager) {
            this.mainManager = mainManager;
            this.activeBatches = new Set();
            this.concurrentFrames = 0;
            this.batchQueue = [];
            this.isProcessingQueue = false;
        }

        async processVehicleBatch(building, vehicles, batchId) {
            this.activeBatches.add(batchId);
            this.mainManager.updateBatchStats();

            const chunks = this.chunkArray(vehicles, Math.ceil(vehicles.length / 2));
            let successful = 0;
            let failed = 0;

            for (const chunk of chunks) {
                if (!this.mainManager.isRunning) break;

                while (this.concurrentFrames >= SETTINGS.maxConcurrentFrames) {
                    await this.mainManager.delay(100);
                    if (!this.mainManager.isRunning) break;
                }

                const result = await this.processChunk(building, chunk, batchId);
                successful += result.successful;
                failed += result.failed;
            }

            this.activeBatches.delete(batchId);
            this.mainManager.updateBatchStats();

            return { successful, failed };
        }

        chunkArray(array, chunkSize) {
            const chunks = [];
            for (let i = 0; i < array.length; i += chunkSize) {
                chunks.push(array.slice(i, i + chunkSize));
            }
            return chunks;
        }

        async processChunk(building, vehicles, batchId) {
            const promises = vehicles.map(vehicle =>
                this.processSingleVehicleWithLimit(building, vehicle, batchId)
            );

            const results = await Promise.allSettled(promises);

            const successful = results.filter(r => r.status === 'fulfilled' && r.value).length;
            const failed = results.length - successful;

            return { successful, failed };
        }

        async processSingleVehicleWithLimit(building, vehicle, batchId) {
            this.concurrentFrames++;
            this.mainManager.updateBatchStats();

            try {
                return await this.mainManager.processSingleVehicle(building, vehicle);
            } finally {
                this.concurrentFrames--;
                this.mainManager.updateBatchStats();
            }
        }
    }

    class SequentialPersonalManager {
        constructor() {
            this.isRunning = false;
            this.isPaused = false;
            this.currentProcess = null;
            this.batchManager = null;
            this.activeFrames = new Set();
            this.batchStatsInterval = null;
            this.init();
        }

        init() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    this.initializeManager();
                });
            } else {
                this.initializeManager();
            }
        }

        initializeManager() {
            if (this.isStartPage()) {
                console.log('LSS Sequential Manager: Startseite erkannt');
                this.batchManager = new BatchManager(this);
                this.createStartPageUI();

                this.batchStatsInterval = setInterval(() => {
                    this.updateBatchStats();
                }, 500);
            }
        }

        isStartPage() {
            return window.location.href === 'https://www.leitstellenspiel.de/' ||
                   window.location.href.includes('/buildings/');
        }

        createStartPageUI() {
            if (document.getElementById('lss-sequential-manager')) return;

            this.addStyles();

            const container = document.createElement('div');
            container.id = 'lss-sequential-manager';

            const header = document.createElement('div');
            header.id = 'lss-sequential-header';

            const title = document.createElement('div');
            title.id = 'lss-sequential-title';
            title.textContent = 'üè¢ LSS Sequential Personal Manager (Batch v4.0)';

            const close = document.createElement('button');
            close.id = 'lss-sequential-close';
            close.textContent = '√ó';
            close.addEventListener('click', () => container.style.display = 'none');

            header.appendChild(title);
            header.appendChild(close);

            const content = document.createElement('div');
            content.id = 'lss-sequential-content';

            content.appendChild(this.createStationSection());
            content.appendChild(this.createBuildingSection());
            content.appendChild(this.createBatchControlSection());
            content.appendChild(this.createActionSection());
            content.appendChild(this.createStatusSection());
            content.appendChild(this.createProgressSection());

            container.appendChild(header);
            container.appendChild(content);
            document.body.appendChild(container);

            this.makeDraggable(container, header);
            this.loadLeitstellen();
        }

        addStyles() {
            const css = `
                #lss-sequential-manager {
                    position: fixed;
                    top: 120px;
                    left: 20px;
                    width: 600px;
                    background: #2d3748;
                    color: #e2e8f0;
                    border: 1px solid #4a5568;
                    border-radius: 8px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    z-index: 9999;
                    font-family: Arial, sans-serif;
                    max-height: 85vh;
                    display: flex;
                    flex-direction: column;
                }

                #lss-sequential-header {
                    background: #1a202c;
                    padding: 12px;
                    border-radius: 8px 8px 0 0;
                    cursor: move;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-bottom: 1px solid #4a5568;
                }

                #lss-sequential-title {
                    font-weight: bold;
                    font-size: 16px;
                    color: #f7fafc;
                }

                #lss-sequential-close {
                    background: none;
                    border: none;
                    color: #e2e8f0;
                    font-size: 18px;
                    cursor: pointer;
                    width: 24px;
                    height: 24px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                #lss-sequential-content {
                    padding: 15px;
                    overflow-y: auto;
                    flex-grow: 1;
                }

                .lss-section {
                    margin-bottom: 15px;
                    padding-bottom: 15px;
                    border-bottom: 1px solid #4a5568;
                }

                .lss-section:last-child {
                    border-bottom: none;
                    margin-bottom: 0;
                }

                .lss-section-title {
                    font-weight: bold;
                    margin-bottom: 8px;
                    color: #63b3ed;
                    font-size: 14px;
                }

                .lss-btn {
                    display: block;
                    width: 100%;
                    padding: 10px;
                    margin: 8px 0;
                    background: #3182ce;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    text-align: center;
                    transition: background 0.2s;
                    font-size: 13px;
                }

                .lss-btn:hover { background: #2b6cb0; }
                .lss-btn:disabled { background: #4a5568; color: #a0aec0; cursor: not-allowed; }
                .lss-btn-success { background: #38a169; }
                .lss-btn-success:hover { background: #2f855a; }
                .lss-btn-danger { background: #e53e3e; }
                .lss-btn-danger:hover { background: #c53030; }
                .lss-btn-warning { background: #ed8936; }
                .lss-btn-warning:hover { background: #dd771b; }

                .lss-select {
                    width: 100%;
                    padding: 8px;
                    margin: 8px 0;
                    background: #4a5568;
                    color: #e2e8f0;
                    border: 1px solid #718096;
                    border-radius: 6px;
                    font-size: 13px;
                }

                .lss-building-list {
                    max-height: 200px;
                    overflow-y: auto;
                    border: 1px solid #4a5568;
                    border-radius: 6px;
                    padding: 10px;
                    background: #1a202c;
                }

                .lss-building-item {
                    margin: 6px 0;
                    padding: 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: background 0.2s;
                    border: 1px solid transparent;
                    display: flex;
                    align-items: center;
                }

                .lss-building-item:hover {
                    background: #2d3748;
                    border-color: #4a5568;
                }

                .lss-building-item input {
                    margin-right: 8px;
                }

                .lss-building-item label {
                    cursor: pointer;
                    flex: 1;
                }

                .lss-message {
                    padding: 10px;
                    margin: 8px 0;
                    border-radius: 6px;
                    font-size: 12px;
                    line-height: 1.4;
                }

                .lss-success { background: #22543d; color: #9ae6b4; border-left: 4px solid #38a169; }
                .lss-error { background: #742a2a; color: #feb2b2; border-left: 4px solid #e53e3e; }
                .lss-info { background: #2c5282; color: #90cdf4; border-left: 4px solid #3182ce; }
                .lss-warning { background: #744210; color: #faf089; border-left: 4px solid #ed8936; }

                .lss-progress-container {
                    margin: 10px 0;
                }

                .lss-progress-label {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 5px;
                    font-size: 12px;
                    color: #a0aec0;
                }

                .lss-progress {
                    width: 100%;
                    height: 20px;
                    background: #4a5568;
                    border-radius: 10px;
                    overflow: hidden;
                }

                .lss-progress-bar {
                    height: 100%;
                    background: linear-gradient(45deg, #48bb78, #38a169);
                    transition: width 0.3s;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 11px;
                    font-weight: bold;
                }

                .lss-stats {
                    display: grid;
                    grid-template-columns: 1fr 1fr 1fr;
                    gap: 10px;
                    margin: 10px 0;
                }

                .lss-stat-item {
                    background: #4a5568;
                    padding: 8px;
                    border-radius: 6px;
                    text-align: center;
                }

                .lss-stat-value {
                    font-size: 18px;
                    font-weight: bold;
                    color: #63b3ed;
                }

                .lss-stat-label {
                    font-size: 11px;
                    color: #a0aec0;
                }

                .lss-iframe-container {
                    position: absolute;
                    width: 1px;
                    height: 1px;
                    left: -9999px;
                    top: -9999px;
                    overflow: hidden;
                }

                .lss-log {
                    max-height: 150px;
                    overflow-y: auto;
                    background: #1a202c;
                    border: 1px solid #4a5568;
                    border-radius: 6px;
                    padding: 8px;
                    font-size: 11px;
                    font-family: monospace;
                }

                .lss-log-entry {
                    margin: 2px 0;
                    padding: 2px 4px;
                    border-radius: 3px;
                }

                .lss-log-success { background: #22543d; color: #9ae6b4; }
                .lss-log-error { background: #742a2a; color: #feb2b2; }
                .lss-log-info { background: #2c5282; color: #90cdf4; }
                .lss-log-warning { background: #744210; color: #faf089; }
                .lss-log-current { background: #2c5282; color: #90cdf4; font-weight: bold; }

                .lss-slider-container {
                    margin: 10px 0;
                }

                .lss-slider-label {
                    font-size: 12px;
                    margin-bottom: 5px;
                    color: #e2e8f0;
                }

                .lss-slider {
                    width: 100%;
                    margin: 5px 0;
                }
            `;

            const style = document.createElement('style');
            style.textContent = css;
            document.head.appendChild(style);
        }

        createStationSection() {
            const section = document.createElement('div');
            section.className = 'lss-section';

            const title = document.createElement('div');
            title.className = 'lss-section-title';
            title.textContent = 'üìç Leitstelle ausw√§hlen';

            const select = document.createElement('select');
            select.className = 'lss-select';
            select.id = 'lss-leitstellen-select';
            select.innerHTML = '<option value="">Leitstellen werden geladen...</option>';

            section.appendChild(title);
            section.appendChild(select);
            return section;
        }

        createBuildingSection() {
            const section = document.createElement('div');
            section.className = 'lss-section';

            const title = document.createElement('div');
            title.className = 'lss-section-title';
            title.textContent = 'üè¢ Geb√§ude ausw√§hlen';

            const selectAll = document.createElement('div');
            selectAll.style.cssText = 'margin-bottom: 10px; font-size: 12px; display: flex; align-items: center;';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = 'lss-select-all';

            const label = document.createElement('label');
            label.htmlFor = 'lss-select-all';
            label.textContent = 'Alle Geb√§ude ausw√§hlen';
            label.style.marginLeft = '8px';

            selectAll.appendChild(checkbox);
            selectAll.appendChild(label);

            const buildingList = document.createElement('div');
            buildingList.id = 'lss-building-list';
            buildingList.className = 'lss-building-list';
            buildingList.innerHTML = '<div class="lss-message lss-info">Bitte zuerst eine Leitstelle ausw√§hlen</div>';

            section.appendChild(title);
            section.appendChild(selectAll);
            section.appendChild(buildingList);

            checkbox.addEventListener('change', (e) => this.handleSelectAll(e.target.checked));
            return section;
        }

        createBatchControlSection() {
            const section = document.createElement('div');
            section.className = 'lss-section';

            const title = document.createElement('div');
            title.className = 'lss-section-title';
            title.textContent = 'üì¶ Batch-Einstellungen';

            // Batch Size Slider
            const batchSizeContainer = document.createElement('div');
            batchSizeContainer.className = 'lss-slider-container';

            const batchSizeLabel = document.createElement('div');
            batchSizeLabel.className = 'lss-slider-label';
            batchSizeLabel.textContent = `Batch-Gr√∂√üe: ${SETTINGS.batchSize} Fahrzeuge`;
            batchSizeLabel.id = 'lss-batch-size-label';

            const batchSizeSlider = document.createElement('input');
            batchSizeSlider.type = 'range';
            batchSizeSlider.className = 'lss-slider';
            batchSizeSlider.min = '1';
            batchSizeSlider.max = '15';
            batchSizeSlider.value = SETTINGS.batchSize;

            batchSizeSlider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                SETTINGS.batchSize = value;
                document.getElementById('lss-batch-size-label').textContent = `Batch-Gr√∂√üe: ${value} Fahrzeuge`;
            });

            batchSizeContainer.appendChild(batchSizeLabel);
            batchSizeContainer.appendChild(batchSizeSlider);

            // Parallel Frames Limit
            const framesLimitContainer = document.createElement('div');
            framesLimitContainer.className = 'lss-slider-container';

            const framesLabel = document.createElement('div');
            framesLabel.className = 'lss-slider-label';
            framesLabel.textContent = `Max. parallele Frames: ${SETTINGS.maxConcurrentFrames}`;
            framesLabel.id = 'lss-frames-label';

            const framesSlider = document.createElement('input');
            framesSlider.type = 'range';
            framesSlider.className = 'lss-slider';
            framesSlider.min = '1';
            framesSlider.max = '15';
            framesSlider.value = SETTINGS.maxConcurrentFrames;

            framesSlider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                SETTINGS.maxConcurrentFrames = value;
                document.getElementById('lss-frames-label').textContent = `Max. parallele Frames: ${value}`;
            });

            framesLimitContainer.appendChild(framesLabel);
            framesLimitContainer.appendChild(framesSlider);

            // Batch-Statistiken
            const batchStats = document.createElement('div');
            batchStats.id = 'lss-batch-stats';
            batchStats.className = 'lss-stats';
            batchStats.innerHTML = `
                <div class="lss-stat-item">
                    <div class="lss-stat-value" id="lss-batch-active">0</div>
                    <div class="lss-stat-label">Aktive Batches</div>
                </div>
                <div class="lss-stat-item">
                    <div class="lss-stat-value" id="lss-batch-frames">0</div>
                    <div class="lss-stat-label">Aktive Frames</div>
                </div>
                <div class="lss-stat-item">
                    <div class="lss-stat-value" id="lss-batch-queue">0</div>
                    <div class="lss-stat-label">In Warteschlange</div>
                </div>
            `;

            section.appendChild(title);
            section.appendChild(batchSizeContainer);
            section.appendChild(framesLimitContainer);
            section.appendChild(batchStats);

            return section;
        }

        createActionSection() {
            const section = document.createElement('div');
            section.className = 'lss-section';

            const title = document.createElement('div');
            title.className = 'lss-section-title';
            title.textContent = '‚ö° Aktionen';

            const startBtn = document.createElement('button');
            startBtn.className = 'lss-btn lss-btn-success';
            startBtn.id = 'lss-start-sequential';
            startBtn.textContent = 'üöÄ Batch-Prozess starten';
            startBtn.disabled = true;

            const pauseBtn = document.createElement('button');
            pauseBtn.className = 'lss-btn lss-btn-warning';
            pauseBtn.id = 'lss-pause-sequential';
            pauseBtn.textContent = '‚è∏Ô∏è Pausieren';
            pauseBtn.style.display = 'none';

            const stopBtn = document.createElement('button');
            stopBtn.className = 'lss-btn lss-btn-danger';
            stopBtn.id = 'lss-stop-sequential';
            stopBtn.textContent = '‚èπÔ∏è Prozess stoppen';
            stopBtn.style.display = 'none';

            section.appendChild(title);
            section.appendChild(startBtn);
            section.appendChild(pauseBtn);
            section.appendChild(stopBtn);
            return section;
        }

        createStatusSection() {
            const section = document.createElement('div');
            section.className = 'lss-section';

            const title = document.createElement('div');
            title.className = 'lss-section-title';
            title.textContent = 'üìä Status';

            const message = document.createElement('div');
            message.id = 'lss-status-message';
            message.className = 'lss-message lss-info';
            message.textContent = 'Bereit - Batch Version 4.0';

            section.appendChild(title);
            section.appendChild(message);
            return section;
        }

        createProgressSection() {
            const section = document.createElement('div');
            section.className = 'lss-section';

            const title = document.createElement('div');
            title.className = 'lss-section-title';
            title.textContent = 'üìà Fortschritt';

            const stats = document.createElement('div');
            stats.className = 'lss-stats';

            stats.innerHTML = `
                <div class="lss-stat-item">
                    <div class="lss-stat-value" id="lss-stat-completed">0</div>
                    <div class="lss-stat-label">Abgeschlossen</div>
                </div>
                <div class="lss-stat-item">
                    <div class="lss-stat-value" id="lss-stat-total">0</div>
                    <div class="lss-stat-label">Gesamt</div>
                </div>
                <div class="lss-stat-item">
                    <div class="lss-stat-value" id="lss-stat-success">0</div>
                    <div class="lss-stat-label">Erfolgreich</div>
                </div>
            `;

            const progressContainer = document.createElement('div');
            progressContainer.className = 'lss-progress-container';

            const progressLabel = document.createElement('div');
            progressLabel.className = 'lss-progress-label';
            progressLabel.innerHTML = '<span>Gesamtfortschritt</span><span id="lss-progress-percent">0%</span>';

            const progress = document.createElement('div');
            progress.className = 'lss-progress';
            progress.innerHTML = '<div class="lss-progress-bar" style="width: 0%"></div>';

            progressContainer.appendChild(progressLabel);
            progressContainer.appendChild(progress);

            const currentTask = document.createElement('div');
            currentTask.id = 'lss-current-task';
            currentTask.className = 'lss-message lss-info';
            currentTask.textContent = 'Keine aktive Aufgabe';

            const log = document.createElement('div');
            log.className = 'lss-log';
            log.id = 'lss-process-log';
            log.innerHTML = '<div class="lss-log-entry lss-log-info">Bereit f√ºr Batch-Verarbeitung...</div>';

            section.appendChild(title);
            section.appendChild(stats);
            section.appendChild(progressContainer);
            section.appendChild(currentTask);
            section.appendChild(log);

            return section;
        }

        async loadLeitstellen() {
            try {
                this.showMessage('Lade Leitstellen...', 'info');
                const buildings = await this.apiCall('/api/buildings');
                const leitstellen = buildings.filter(b => b.building_type === 7);

                const select = document.getElementById('lss-leitstellen-select');
                select.innerHTML = '';

                if (leitstellen.length === 0) {
                    select.innerHTML = '<option value="">Keine Leitstellen gefunden</option>';
                    this.showMessage('Keine Leitstellen gefunden', 'warning');
                } else {
                    select.innerHTML = '<option value="">Leitstelle ausw√§hlen</option>';
                    leitstellen.forEach(ls => {
                        const option = document.createElement('option');
                        option.value = ls.id;
                        option.textContent = ls.caption;
                        select.appendChild(option);
                    });
                    this.showMessage(`${leitstellen.length} Leitstellen geladen`, 'success');
                }

                select.addEventListener('change', () => this.handleLeitstellenChange());
                document.getElementById('lss-start-sequential').addEventListener('click', () => this.startSequentialProcess());
                document.getElementById('lss-pause-sequential').addEventListener('click', () => this.togglePause());
                document.getElementById('lss-stop-sequential').addEventListener('click', () => this.stopSequentialProcess());

            } catch (error) {
                console.error('Fehler beim Laden der Leitstellen:', error);
                this.showMessage('Fehler beim Laden der Leitstellen', 'error');
            }
        }

        async handleLeitstellenChange() {
            const leitstellenId = document.getElementById('lss-leitstellen-select').value;
            if (!leitstellenId) return;

            try {
                this.showMessage('Lade Geb√§ude...', 'info');
                const buildings = await this.apiCall('/api/buildings');
                const gebaeude = buildings.filter(b =>
                    b.building_type !== 7 && b.leitstelle_building_id == leitstellenId
                );

                const buildingList = document.getElementById('lss-building-list');
                buildingList.innerHTML = '';

                if (gebaeude.length === 0) {
                    buildingList.innerHTML = '<div class="lss-message lss-warning">Keine Geb√§ude in dieser Leitstelle gefunden</div>';
                    this.showMessage('Keine Geb√§ude gefunden', 'warning');
                    return;
                }

                gebaeude.forEach(building => {
                    const item = document.createElement('div');
                    item.className = 'lss-building-item';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = building.id;

                    const label = document.createElement('label');
                    label.textContent = building.caption;

                    item.appendChild(checkbox);
                    item.appendChild(label);

                    item.addEventListener('click', (e) => {
                        if (e.target !== checkbox) {
                            checkbox.checked = !checkbox.checked;
                        }
                        this.updateStartButton();
                    });

                    buildingList.appendChild(item);
                });

                this.showMessage(`${gebaeude.length} Geb√§ude geladen`, 'success');
                this.updateStartButton();

            } catch (error) {
                console.error('Fehler beim Laden der Geb√§ude:', error);
                this.showMessage('Fehler beim Laden der Geb√§ude', 'error');
            }
        }

        handleSelectAll(checked) {
            const checkboxes = document.querySelectorAll('#lss-building-list input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checked);
            this.updateStartButton();
        }

        updateStartButton() {
            const selected = this.getSelectedBuildings();
            const btn = document.getElementById('lss-start-sequential');
            btn.disabled = selected.length === 0;

            if (selected.length > 0) {
                this.showMessage(`${selected.length} Geb√§ude ausgew√§hlt`, 'success');
            } else {
                this.showMessage('Keine Geb√§ude ausgew√§hlt', 'info');
            }
        }

        getSelectedBuildings() {
            const checkboxes = document.querySelectorAll('#lss-building-list input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => ({
                id: cb.value,
                name: cb.nextElementSibling.textContent
            }));
        }

        async startSequentialProcess() {
            if (this.isRunning) {
                this.showMessage('Prozess l√§uft bereits', 'warning');
                return;
            }

            const selectedBuildings = this.getSelectedBuildings();
            if (selectedBuildings.length === 0) {
                this.showMessage('Bitte Geb√§ude ausw√§hlen', 'error');
                return;
            }

            this.isRunning = true;
            this.isPaused = false;
            this.currentProcess = {
                buildings: selectedBuildings,
                currentBuildingIndex: 0,
                currentVehicleIndex: 0,
                processedVehicles: 0,
                totalVehicles: 0,
                successfulAssignments: 0,
                failedAssignments: 0,
                startTime: Date.now()
            };

            // UI aktualisieren
            document.getElementById('lss-start-sequential').style.display = 'none';
            document.getElementById('lss-pause-sequential').style.display = 'block';
            document.getElementById('lss-stop-sequential').style.display = 'block';
            document.getElementById('lss-leitstellen-select').disabled = true;
            document.querySelectorAll('#lss-building-list input').forEach(cb => cb.disabled = true);

            this.showMessage('Starte Batch-Prozess...', 'info');
            this.addLog('üöÄ BATCH-Prozess gestartet', 'info');
            this.addLog(`üì¶ Batch-Gr√∂√üe: ${SETTINGS.batchSize}, Max Frames: ${SETTINGS.maxConcurrentFrames}`, 'info');

            // Berechne Gesamtanzahl der Fahrzeuge
            await this.calculateTotalVehicles();

            // Starte die sequentielle Verarbeitung
            this.processNextBuilding();
        }

        togglePause() {
            this.isPaused = !this.isPaused;
            const btn = document.getElementById('lss-pause-sequential');

            if (this.isPaused) {
                btn.textContent = '‚ñ∂Ô∏è Fortsetzen';
                this.showMessage('Prozess pausiert', 'warning');
                this.addLog('‚è∏Ô∏è Prozess pausiert', 'warning');
            } else {
                btn.textContent = '‚è∏Ô∏è Pausieren';
                this.showMessage('Prozess fortgesetzt', 'info');
                this.addLog('‚ñ∂Ô∏è Prozess fortgesetzt', 'info');
                this.processNextBuilding();
            }
        }

        async calculateTotalVehicles() {
            this.currentProcess.totalVehicles = 0;

            for (const building of this.currentProcess.buildings) {
                try {
                    const vehicles = await this.apiCall(`/api/buildings/${building.id}/vehicles`);
                    const vehiclesToProcess = vehicles.filter(v =>
                        VEHICLE_CONFIG.some(c => c[0] == v.vehicle_type)
                    );
                    this.currentProcess.totalVehicles += vehiclesToProcess.length;
                    this.addLog(`üìä ${building.name}: ${vehiclesToProcess.length} Fahrzeuge`, 'info');
                } catch (error) {
                    console.error(`Fehler beim Laden der Fahrzeuge f√ºr ${building.name}:`, error);
                    this.addLog(`‚ùå Fehler beim Laden von ${building.name}`, 'error');
                }
            }

            this.updateStats();
            this.addLog(`üìà Gesamt: ${this.currentProcess.totalVehicles} Fahrzeuge in ${this.currentProcess.buildings.length} Geb√§uden`, 'info');
        }

        async processNextBuilding() {
            if (!this.isRunning || this.isPaused) return;

            // Pr√ºfe ob alle Geb√§ude bearbeitet wurden
            if (this.currentProcess.currentBuildingIndex >= this.currentProcess.buildings.length) {
                this.addLog('‚úÖ Alle Geb√§ude abgeschlossen!', 'success');
                this.showMessage('Batch-Prozess abgeschlossen!', 'success');
                this.stopSequentialProcess();
                return;
            }

            const building = this.currentProcess.buildings[this.currentProcess.currentBuildingIndex];

            try {
                this.addLog(`üè¢ Starte Geb√§ude: ${building.name}`, 'info');
                this.updateCurrentBuildingTask(building);

                const vehicles = await this.apiCall(`/api/buildings/${building.id}/vehicles`);
                const vehiclesToProcess = vehicles.filter(v =>
                    VEHICLE_CONFIG.some(c => c[0] == v.vehicle_type)
                );

                if (vehiclesToProcess.length === 0) {
                    this.addLog(`‚ÑπÔ∏è Keine passenden Fahrzeuge in ${building.name}`, 'info');
                    this.currentProcess.currentBuildingIndex++;
                    await this.delay(SETTINGS.betweenBuildings);
                    this.processNextBuilding();
                    return;
                }

                // Verarbeite das gesamte Geb√§ude in Batches
                const result = await this.processBuildingInBatches(building, vehiclesToProcess);

                this.addLog(`‚úÖ ${building.name} abgeschlossen: ${result.successful}/${vehiclesToProcess.length} erfolgreich`, 'success');

                // N√§chstes Geb√§ude
                this.currentProcess.currentBuildingIndex++;
                this.currentProcess.currentVehicleIndex = 0;

                // Kurze Pause zwischen Geb√§uden
                await this.delay(SETTINGS.betweenBuildings);

                // N√§chstes Geb√§ude verarbeiten
                this.processNextBuilding();

            } catch (error) {
                console.error(`Fehler beim Verarbeiten von Geb√§ude ${building.name}:`, error);
                this.addLog(`‚ùå Fehler bei ${building.name}, √ºberspringe...`, 'error');

                // Fehlerhaftes Geb√§ude √ºberspringen und mit n√§chstem fortfahren
                this.currentProcess.currentBuildingIndex++;
                await this.delay(SETTINGS.betweenBuildings);
                this.processNextBuilding();
            }
        }

        async processBuildingInBatches(building, vehicles) {
            const totalVehicles = vehicles.length;
            let processedInBuilding = 0;
            let totalSuccessful = 0;
            let totalFailed = 0;

            // Teile Fahrzeuge in Batches auf
            for (let i = 0; i < totalVehicles; i += SETTINGS.batchSize) {
                if (!this.isRunning || this.isPaused) break;

                const batchVehicles = vehicles.slice(i, i + SETTINGS.batchSize);
                const batchNumber = Math.floor(i / SETTINGS.batchSize) + 1;
                const totalBatches = Math.ceil(totalVehicles / SETTINGS.batchSize);
                const batchId = `batch_${building.id}_${i}`;

                this.addLog(`üì¶ Batch ${batchNumber}/${totalBatches} mit ${batchVehicles.length} Fahrzeugen`, 'info');

                // Verarbeite Batch
                const result = await this.batchManager.processVehicleBatch(building, batchVehicles, batchId);

                // Update Statistiken
                processedInBuilding += batchVehicles.length;
                totalSuccessful += result.successful;
                totalFailed += result.failed;

                this.currentProcess.processedVehicles += batchVehicles.length;
                this.currentProcess.successfulAssignments += result.successful;
                this.currentProcess.failedAssignments += result.failed;

                this.currentProcess.currentVehicleIndex += batchVehicles.length;

                this.updateProgress();
                this.updateCurrentBatchTask(building, processedInBuilding, totalVehicles, batchNumber, totalBatches);

                // Kurze Pause zwischen Batches (au√üer beim letzten Batch)
                if (i + SETTINGS.batchSize < totalVehicles) {
                    await this.delay(SETTINGS.batchDelay);
                }
            }

            return { successful: totalSuccessful, failed: totalFailed };
        }

        async processSingleVehicle(building, vehicle) {
            return new Promise((resolve) => {
                const frameId = `frame_${vehicle.id}_${Date.now()}`;
                const frame = document.createElement('iframe');
                frame.id = frameId;
                frame.className = 'lss-iframe-container';
                frame.src = `https://www.leitstellenspiel.de/vehicles/${vehicle.id}/zuweisung`;

                this.activeFrames.add(frameId);

                frame.onload = async () => {
                    try {
                        await this.delay(SETTINGS.pageLoadDelay);
                        const success = await this.optimizedFrameAssignment(frame, vehicle.id);

                        if (success) {
                            this.addLog(`‚úÖ ${vehicle.caption || vehicle.id} erfolgreich`, 'success');
                            resolve(true);
                        } else {
                            this.addLog(`‚ö†Ô∏è ${vehicle.caption || vehicle.id} teilweise/nicht zugewiesen`, 'warning');
                            resolve(false);
                        }

                    } catch (error) {
                        console.error(`Fehler in Frame ${vehicle.id}:`, error);
                        this.addLog(`‚ùå Fehler bei ${vehicle.caption || vehicle.id}`, 'error');
                        resolve(false);
                    } finally {
                        this.cleanupFrame(frameId);
                    }
                };

                frame.onerror = () => {
                    this.addLog(`‚ùå Frame-Fehler bei ${vehicle.caption || vehicle.id}`, 'error');
                    this.cleanupFrame(frameId);
                    resolve(false);
                };

                document.body.appendChild(frame);
            });
        }

        async optimizedFrameAssignment(frame, vehicleId) {
            try {
                const frameDoc = frame.contentDocument || frame.contentWindow.document;
                const vehicleType = await this.getVehicleTypeFromFrame(frameDoc);
                if (!vehicleType) return false;

                const personGoal = VEHICLE_CONFIG.filter(config => config[0] == vehicleType);
                if (personGoal.length === 0) return false;

                const tableLoaded = await this.waitForTableOptimized(frameDoc);
                if (!tableLoaded) return false;

                return await this.fastPersonAssignment(frameDoc, personGoal);

            } catch (error) {
                console.error('Fehler bei optimierter Frame-Zuweisung:', error);
                return false;
            }
        }

        async getVehicleTypeFromFrame(frameDoc) {
            try {
                const scriptTags = frameDoc.querySelectorAll('script');
                for (let script of scriptTags) {
                    const match = script.textContent.match(/vehicle_type["']?:\s*["']?(\d+)/);
                    if (match) return match[1];
                }

                const urlMatch = frameDoc.location.href.match(/\/vehicles\/(\d+)/);
                if (urlMatch) {
                    const vehicle = await this.apiCall(`/api/vehicles/${urlMatch[1]}`);
                    return vehicle.vehicle_type;
                }
            } catch (e) {
                console.warn('Konnte Vehicle-Type nicht aus Frame extrahieren:', e);
            }
            return null;
        }

        async waitForTableOptimized(frameDoc, maxRetries = 8) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    if (frameDoc.querySelector('#personal_table tbody tr')) {
                        return true;
                    }
                } catch (e) {
                    // Cross-origin Fehler abfangen
                }
                await this.delay(SETTINGS.retryDelay);
            }
            return false;
        }

        async fastPersonAssignment(frameDoc, personGoal) {
            const allPeople = Array.from(frameDoc.querySelectorAll('#personal_table tbody tr'));
            const maxPerVehicle = personGoal.map(e => e[2]);
            let curSelected = Array(personGoal.length).fill(0);
            let assignedNew = false;

            for (let i = 0; i < allPeople.length; i++) {
                const person = allPeople[i];
                if (!this.isPersonAvailableInFrame(person)) continue;

                const training = this.getPersonTrainingInFrame(person);
                const isAssigned = this.isPersonAssignedInFrame(person);

                const configIndex = this.findMatchingConfig(training, personGoal);
                if (configIndex === -1) continue;

                if (isAssigned) {
                    if (this.hasCorrectTraining(training, personGoal[configIndex])) {
                        curSelected[configIndex]++;
                    } else {
                        await this.unselectPersonInFrame(person, null);
                    }
                    continue;
                }

                if (curSelected[configIndex] < maxPerVehicle[configIndex]) {
                    if (this.hasCorrectTraining(training, personGoal[configIndex])) {
                        await this.selectPersonInFrame(person, null);
                        curSelected[configIndex]++;
                        assignedNew = true;
                    }
                }
            }

            return assignedNew;
        }

        findMatchingConfig(training, personGoal) {
            for (let i = 0; i < personGoal.length; i++) {
                if ((personGoal[i][1] !== "" && training.includes(personGoal[i][1])) ||
                    (personGoal[i][1] === "" && training === "")) {
                    return i;
                }
            }
            return -1;
        }

        hasCorrectTraining(training, config) {
            return config[1] === "" ? training === "" : training.includes(config[1]);
        }

        getPersonTrainingInFrame(person) {
            const td = person.querySelector('td:nth-child(2)');
            return td ? td.textContent.trim() : '';
        }

        isPersonAssignedInFrame(person) {
            return !!person.querySelector('.btn-assigned');
        }

        isPersonAvailableInFrame(person) {
            const hasSuccessBtn = !!person.querySelector('.btn-success');
            const td3 = person.querySelector('td:nth-child(3)');
            const isInTraining = td3 ? td3.textContent.includes('Im Unterricht') : false;
            return hasSuccessBtn && !isInTraining;
        }

        async selectPersonInFrame(person, frame) {
            const btn = person.querySelector('.btn-success');
            if (btn) {
                btn.click();
                await this.delay(SETTINGS.pressDelay);
            }
        }

        async unselectPersonInFrame(person, frame) {
            const btn = person.querySelector('.btn-assigned');
            if (btn) {
                btn.click();
                await this.delay(SETTINGS.pressDelay);
            }
        }

        cleanupFrame(frameId) {
            const frame = document.getElementById(frameId);
            if (frame && frame.parentNode) {
                frame.parentNode.removeChild(frame);
            }
            this.activeFrames.delete(frameId);
        }

        stopSequentialProcess() {
            this.isRunning = false;
            this.isPaused = false;

            // Alle aktiven Frames bereinigen
            this.activeFrames.forEach(frameId => {
                this.cleanupFrame(frameId);
            });
            this.activeFrames.clear();

            // UI zur√ºcksetzen
            document.getElementById('lss-start-sequential').style.display = 'block';
            document.getElementById('lss-pause-sequential').style.display = 'none';
            document.getElementById('lss-stop-sequential').style.display = 'none';
            document.getElementById('lss-leitstellen-select').disabled = false;
            document.querySelectorAll('#lss-building-list input').forEach(cb => cb.disabled = false);

            document.getElementById('lss-current-task').textContent = 'Keine aktive Aufgabe';
            document.getElementById('lss-current-task').className = 'lss-message lss-info';

            // Berechne Laufzeit
            if (this.currentProcess && this.currentProcess.startTime) {
                const runtime = Math.round((Date.now() - this.currentProcess.startTime) / 1000 / 60);
                this.addLog(`‚è±Ô∏è Laufzeit: ${runtime} Minuten`, 'info');
            }

            this.showMessage('Batch-Prozess gestoppt', 'info');
            this.addLog('‚èπÔ∏è Batch-Prozess gestoppt', 'info');
        }

        updateCurrentBuildingTask(building) {
            const currentTask = document.getElementById('lss-current-task');
            const progress = Math.round((this.currentProcess.processedVehicles / this.currentProcess.totalVehicles) * 100);

            currentTask.textContent = `Aktuelles Geb√§ude: ${building.name} (${progress}% gesamt)`;
            currentTask.className = 'lss-message lss-info';
        }

        updateCurrentBatchTask(building, processed, total, batchNumber, totalBatches) {
            const currentTask = document.getElementById('lss-current-task');
            const buildingProgress = Math.round((processed / total) * 100);
            const overallProgress = Math.round((this.currentProcess.processedVehicles / this.currentProcess.totalVehicles) * 100);

            let taskText = `Geb√§ude: ${building.name} (${buildingProgress}%) | Gesamt: ${overallProgress}%`;
            if (batchNumber && totalBatches) {
                taskText += ` | Batch: ${batchNumber}/${totalBatches}`;
            }

            currentTask.textContent = taskText;
            currentTask.className = 'lss-message lss-info';
        }

        updateProgress() {
            const total = this.currentProcess.totalVehicles;
            const processed = this.currentProcess.processedVehicles;
            const percent = total > 0 ? (processed / total) * 100 : 0;

            const progressBar = document.querySelector('.lss-progress-bar');
            const progressPercent = document.getElementById('lss-progress-percent');

            if (progressBar) {
                progressBar.style.width = `${percent}%`;
                progressBar.textContent = `${Math.round(percent)}%`;
            }
            if (progressPercent) progressPercent.textContent = `${Math.round(percent)}%`;

            this.updateStats();
        }

        updateStats() {
            if (!this.currentProcess) return;

            document.getElementById('lss-stat-completed').textContent = this.currentProcess.processedVehicles;
            document.getElementById('lss-stat-total').textContent = this.currentProcess.totalVehicles;
            document.getElementById('lss-stat-success').textContent = this.currentProcess.successfulAssignments;
        }

        updateBatchStats() {
            if (!this.batchManager) return;

            document.getElementById('lss-batch-active').textContent = this.batchManager.activeBatches.size;
            document.getElementById('lss-batch-frames').textContent = this.batchManager.concurrentFrames;
            document.getElementById('lss-batch-queue').textContent = this.batchManager.batchQueue.length;
        }

        addLog(message, type = 'info') {
            const log = document.getElementById('lss-process-log');
            const entry = document.createElement('div');
            entry.className = `lss-log-entry lss-log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        async apiCall(url) {
            return new Promise((resolve, reject) => {
                GM_xmlhttpRequest({
                    method: 'GET',
                    url: `https://www.leitstellenspiel.de${url}`,
                    credentials: 'include',
                    onload: (response) => {
                        if (response.status === 200) {
                            try {
                                const data = JSON.parse(response.responseText);
                                resolve(data.result || data);
                            } catch (e) {
                                reject(e);
                            }
                        } else {
                            reject(new Error(`API Error: ${response.status}`));
                        }
                    },
                    onerror: reject
                });
            });
        }

        showMessage(message, type = 'info') {
            const element = document.getElementById('lss-status-message');
            if (element) {
                element.textContent = message;
                element.className = `lss-message lss-${type}`;
            }
        }

        makeDraggable(element, handle) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            handle.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    }

    // Initialisierung
    new SequentialPersonalManager();

})();